
## ğŸ§  Concetto da ribadire prima del Lab

> â€œNoi **creiamo il desired state sullâ€™Hub**, lo **associamo al ClusterSet tramite Placement/Binding**, poi i **controller nei Managed cluster valutano la compliance e rimandano lo status**. Se serve, i controller locali applicano la remediation.â€

---

## ğŸ§ª Commento didattico del Lab collegato allâ€™architettura

### **1. Preparazione ambiente**

```
lab install do0013l ; lab start policies-deploy
```

ğŸ“Œ Qui stiamo solo preparando il workstation: **ACM non Ã¨ ancora coinvolto**, stiamo creando le condizioni per lavorare.

---

### **2. Login al cluster Hub**

```
oc login -u admin -p redhatocp https://api.ocp4.example.com:6443
```

ğŸ“Œ Ora entriamo nel **cluster Hub**, cioÃ¨ il *cervello della governance*.
Da questo momento, **tutto ciÃ² che creeremo come Policy root vivrÃ  nellâ€™Hub**.

---

### **3. Creazione del Project / Namespace utente**

```
oc new-project policies-deploy
```

ğŸ“Œ Questo namespace (`policies-deploy`) Ã¨ il nostro **User namespace dellâ€™Hub**, dove:

* Lâ€™utente (lo studente/admin) **crea la Policy root**
* Vivono anche le risorse di binding al ClusterSet

ğŸ¯ Collegamento architetturale: *Policy Custom Resource (root) â€“ user namespace sullâ€™Hub*

---

### **4. Binding del ClusterSet al namespace del Lab (via console UI)**

Gli studenti vanno in:

```
Infrastructure â†’ Clusters â†’ Cluster sets â†’ default â†’ edit namespace bindings â†’ policies-deploy â†’ Save
```

ğŸ“Œ Qui stiamo creando il concetto equivalente a un:

ğŸ¯ *ManagedClusterSetBinding*, che nellâ€™architettura serve a:

* Permettere al namespace utente dellâ€™Hub di **â€œvedere e usare il ClusterSet defaultâ€**
* Fare in modo che PlacementBinding possa applicare la policy a quel set di cluster

ğŸ”‘ Messaggio chiave per studenti:

> â€œSenza questo binding, il propagator **non avrebbe un cluster group a cui intestare le repliche delle policy**.â€

---

### **5. Creazione della Policy dalla Governance Dashboard**

Gli studenti fanno:

```
Governance â†’ Policies â†’ Create Policy
```

E configurano:

| Campo             | Valore                                   |
| ----------------- | ---------------------------------------- |
| Name              | `certificate-policy-console-ingress`     |
| Namespace         | `policies-deploy`                        |
| Disabled          | âŒ non selezionato                        |
| Template          | `Certificate expiration (300h)`          |
| Namespace include | `openshift-console`, `openshift-ingress` |
| Remediation       | `Inform`                                 |
| Severity          | `High`                                   |
| Placement         | `All clusters`, `ClusterSet = default`   |

ğŸ“Œ Qui stiamo creando:

ğŸ¯ **Policy Custom Resource (root) â€“ Spec**

Subito dopo il Submit, entra in azione il:

ğŸ¯ **Policy Propagator Controller**, che:

1. Legge la root policy
2. Legge Placement + PlacementBinding
3. Crea una **Policy replicata per ogni cluster del ClusterSet default**, ma la crea nei **namespace dellâ€™Hub che rappresentano i cluster gestiti**

â¡ï¸ Questo Ã¨ il box:

ğŸ¯ *Policy Custom Resource (replicated) â€“ Spec (sullâ€™Hub, nei namespace che rappresentano i cluster)*

> â€œQueste repliche sullâ€™Hub non controllano il cluster Hub: sono come fascicoli intestati ai cluster remoti, dove scriveremo lo Status quando risponderanno.â€

---

### **6. Installazione dei Policy Controller nei cluster gestiti**

(anche se il lab non lo fa a mano, avviene implicitamente)

ğŸ¯ Questo step architetturale corrisponde a:

* **Governance Policy Add-On Controller** (sullâ€™Hub) che gestisce
* **Installation of Policy Controllers** (nei Managed cluster)

Messaggio da docente:

> â€œACM ora sta installando nei cluster gestiti i sensori che faranno i controlli.â€

---

### **7. Sincronizzazione della Spec nel Managed cluster**

(nei cluster remoti, avviene automaticamente dopo la replica)

ğŸ¯ Corrisponde a: **Spec Sync Controller** (Managed)

> â€œLa spec che lâ€™Hub ha replicato nel namespace dellâ€™Hub viene ora sincronizzata nel namespace locale del cluster gestito, cosÃ¬ i controller locali possono leggerla.â€

---

### **8. Valutazione della compliance nei namespace richiesti**

ğŸ¯ Corrisponde a: **Policy Controllers locali**

* Il controller `CertificatePolicy` ispeziona i namespace `openshift-console` e `openshift-ingress`
* Se trova certificati in scadenza < 300h, genera eventi Kubernetes

---

### **9. Visualizzazione delle violazioni**

Gli studenti cliccano:

```
Governance â†’ Policies â†’ certificate-policy-console-ingress â†’ Results
```

E vedono:

> â€œViolation nel namespace openshift-ingress per il certificato router-certâ€

ğŸ“Œ Quello che stanno leggendo viene da:

ğŸ¯ **Events for Policy** (Managed cluster)
ğŸ¯ **Policy Custom Resource (replicated) â€“ Status** (Hub namespace che rappresenta il cluster)

> â€œIl Managed cluster ha risposto allâ€™Hub scrivendo lo Status nel suo fascicolo (namespace cluster-representation) e inviando gli eventi.â€

---

### **10. Remediation (se si passasse a Enforce)**

Nel lab poi applicheranno un fix e ricontrolleranno lo Status.

ğŸ¯ Questo sarebbe applicato da:

* **Policy controller locale nel Managed cluster** (remediation)
* **Status Sync + Policy Propagator** per aggiornare lo Status root sullâ€™Hub
* **Governance Dashboard** per visualizzare il risultato finale

---

## ğŸ” Ciclo completo che gli studenti devono visualizzare

| Direzione     | Cosa viaggia                                   |
| ------------- | ---------------------------------------------- |
| Hub â†’ Managed | **Spec della Policy** (desired state)          |
| Managed â†’ Hub | **Status della Policy + Eventi di violazione** |

---

## ğŸ§‘â€ğŸ« Script narrativo consigliato mentre mostri lâ€™animazione delle slide

> â€œOra creiamo la root policy nel nostro namespace sullâ€™Hub.
> Il Placement la assegna al ClusterSet default.
> Il Policy Propagator crea un fascicolo per cluster nei namespace dellâ€™Hub.
> Lâ€™Add-On installa i controller di verifica nei Managed cluster.
> Il Managed cluster sincronizza la spec localmente.
> I Policy Controller controllano i certificati nei namespace richiesti.
> Se qualcosa viola le regole, generano eventi e aggiornano lo Status.
> Lo Status risale allâ€™Hub e viene aggregato.
> Infine la dashboard ci mostra chi Ã¨ compliant e chi no.â€
 
