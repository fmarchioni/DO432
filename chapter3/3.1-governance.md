
# üèõÔ∏è Governance in RHACM: concetto chiave

```
lab install do0013l ; lab start policies-deploy
```

La Governance √® una parte essenziale di questo corso, dobbiamo scomporla in due parti:

* Vediamo dal punto di vista architetturale come funziona. Questo ci servir√† per capire le risorse in gioco e fare troubleshooting se le cose non funzionano
* Poi dobbiamo vedere la grammatica delle Policy. Anche qui, si pu√≤ utilizzare la console per la generazione delle Policy dai template disponibili, ma se vogliamo delle customizzazione dobbiamo saperle scrivere.

Iniziamo a vedere il giro del fumo facendo il Deploy di una Policy semplice che abbiamo nel laboratorio.

**Fai il deploy della policy**

---

## üé§ Script di spiegazione ‚Äì **Flusso della Policy sull‚ÄôHub RHACM**



Quando parliamo di governance in RHACM, dobbiamo immaginare **un sistema diviso in due mondi**:
l‚Äô**Hub cluster**, dove le regole vengono definite e orchestrate, e i **managed cluster**, dove quelle regole vengono effettivamente applicate e verificate.

Sull‚Äô**Hub** noi scriviamo le policy: √® l√¨ che decidiamo *cosa* deve essere rispettato e *da quali cluster*.
Ma l‚ÄôHub **non applica direttamente nulla** sui cluster remoti: coordina, distribuisce e raccoglie risultati.

Il componente chiave sull‚ÄôHub √® il **Policy Propagator Controller**.
Il suo lavoro √® prendere la *policy root* che abbiamo definito e, in base ai Placement, **replicarla nei namespace dell‚ÄôHub che rappresentano i cluster gestiti**.

In pratica fa da intermediario: capisce *a quali cluster si applica la policy*, ne crea le copie tecniche e poi **raccoglie lo stato di compliance** che arriva da ogni cluster, aggregandolo nella policy principale.
Se abbiamo configurato remediation automatiche o automazioni, √® sempre lui che le attiva.
√à il componente che tiene insieme **distribuzione e visione globale dello stato**.

A questo punto ci spostiamo sui **managed cluster**.
Qui non troviamo la governance ‚Äúdecisionale‚Äù, ma **l‚Äôesecuzione**.

In ogni cluster managed gira il **Governance Policy Framework**, che possiamo vedere come un agente locale.
Questo agente riceve le policy sincronizzate dall‚ÄôHub, le mantiene allineate, **esegue i controlli reali sul cluster** e raccoglie eventi e risultati di compliance.
Ogni tipo di policy viene valutato da controller specializzati, e lo stato finale viene poi rimandato all‚ÄôHub.

Quindi, in sintesi:
l‚Äô**Hub decide e coordina**,
i **managed cluster eseguono e riportano**.
Le policy non sono ‚Äúmagicamente globali‚Äù: vengono **replicate, sincronizzate, valutate localmente** e solo dopo **aggregate di nuovo** a livello centrale.

 
Adesso vediamo dal vivo come questi oggetti si coordinano tra loro.

Facciamo il deploy della Policy di esempio del primo esercizio

**Fai esercizio e fermati dopo il deploy**


---

### 1Ô∏è‚É£ Punto di partenza: siamo sull‚ÄôHub

> ‚ÄúPartiamo dall‚ÄôHub cluster, perch√© **tutta la governance nasce qui**.


```bash
oc login -u admin -p redhatocp https://api.ocp4.example.com:6443
```

> ‚ÄúQuesto √® importante: **non stiamo lavorando sul managed cluster**, ma sull‚ÄôHub.

---

### 2Ô∏è‚É£ La Root Policy vive nel namespace *policies-deploy*

```bash
oc get policy -n policies-deploy
```

> ‚ÄúQui vediamo la nostra **root policy**:
> `certificate-policy-console-ingress`.‚Äù

Messaggio chiave agli studenti:

> ‚ÄúQuesta policy **esiste solo sull‚ÄôHub** ed √® *la fonte di verit√†*.‚Äù

---

### 3Ô∏è‚É£ Cosa contiene davvero questa Policy?

```bash
oc describe policy certificate-policy-console-ingress -n policies-deploy
```

> ‚ÄúQui dentro non c‚Äô√® ancora nessun cluster.
> C‚Äô√® **solo l‚Äôintento**.‚Äù

Spiegazione guidata:

* Non stiamo dicendo *dove* applicarla
* Stiamo dicendo *cosa* controllare:

  * certificati
  * namespace `openshift-console` e `openshift-ingress`
  * durata minima 300h
  * remediation `inform`

> ‚ÄúFin qui, questa policy **non tocca nessun cluster**.‚Äù

---

### 4Ô∏è‚É£ Il collegamento fondamentale: Placement

Ora sposti l‚Äôattenzione:

```bash
oc get placement -n policies-deploy
```

> ‚ÄúEd ecco il primo punto chiave del flusso.‚Äù

Messaggio importante:

> ‚ÄúLa policy **non interagisce direttamente con i cluster**.
> Parla con un **Placement**.‚Äù

Spiegalo cos√¨:

* Il Placement dice:

  * *quanti cluster*
  * *di quali ClusterSet*
* Qui vediamo che:

  * il Placement ha avuto successo
  * ha selezionato **1 cluster**

---



Adesso vediamo la parte pi√π delicata:

```bash
oc get policy -A | grep policies-deploy
```


> ‚ÄúGuardate bene:
> vediamo **due policy**, ma **siamo ancora sull‚ÄôHub**.‚Äù

* una in `policies-deploy`
* una in `local-cluster`


## 1Ô∏è‚É£ La policy in `policies-deploy` √® la root-policy quindi √® **astratta**

> Non √® legata a nessun cluster specifico.‚Äù

> ‚Äú√à come dire: *questa √® la regola aziendale*.‚Äù

---

## 2Ô∏è‚É£ La policy replicata "local-cluster" ha invece informazioni di contesto

> ‚ÄúLa policy replicata nel namespace `local-cluster`:
>
> * √® identica nella spec
> * ma √® **contestualizzata a quel cluster**‚Äù

> ‚Äú√à come un template che viene istanziato per ogni cluster.‚Äù



---

### Chi fa questo sdoppiamento delle policy? Il Policy Propagator



```bash
oc get pods -n open-cluster-management | grep propagator
```

> ‚ÄúQuesto √® il controller che fa il lavoro sporco:
> **grc-policy-propagator**.‚Äù

Spiegazione:

* legge la root policy
* valuta Placement + PlacementBinding
* **crea una policy figlia** nel namespace del cluster

Qui vediamo tutto il flusso reale:

```bash
oc logs grc-policy-propagator-6c6668b5f-5h2fh -n open-cluster-management
```

Evidenzia verbalmente queste righe:

* **Reconciling the policy**
* **Created replicated policy**
* Namespace: `local-cluster`
* Nome: `policies-deploy.certificate-policy-console-ingress`

Messaggio chiave:

> ‚ÄúLa policy viene **copiata**, non spostata.
> Rimane la root in `policies-deploy`
> e nasce una **replica per cluster**.‚Äù



## Andiamo sul Managed Cluster

Adesso sull' Hub abbiamo visto tutto quello che c'era da vedere. Andiamo sul Managed Cluster

---


```bash
oc login -u admin -p redhatocp https://api.ocp4-mng.example.com:6443
```


üëâ **qui non esistono Placement, ClusterSet, root policy**



Anzi, vi dico di pi√†, non ci trovate nemmeno le Policy dentro:

 
```bash
oc get policy -n managed-cluster
No resources found in managed-cluster namespace.
```

üëâ qui esistono **solo agenti ed esecuzione**


* le **Policy CR (`kind: Policy`) vivono sull‚ÄôHub**
* il managed cluster **non governa**, **esegue**


## Quello che c'√® √® il framework di governance che subisce le regole:

```bash
oc get deploy governance-policy-framework \
  -n open-cluster-management-agent-addon
```

Risultato:

```
READY   UP-TO-DATE   AVAILABLE
1/1     1            1
```

üéØ Spiegazione:

> ‚ÄúQuesto √® il *motore* della governance, non la policy.‚Äù


* il framework **non contiene regole**
* √® solo l‚Äôinfrastruttura che le applica

---

> ‚ÄúOgni tipo di policy ha il suo controller.‚Äù


```bash
oc get deploy cert-policy-controller \
  -n open-cluster-management-agent-addon
```

Se vedi, nel namespace  open-cluster-management-agent-addon ci sono anche controller per altri tipi di policy:


* `cert-policy-controller`
* `config-policy-controller`
* `application-manager` (per app policies)

üëâ **Non esiste ‚Äúun controller unico‚Äù**
üëâ architettura a **controller specializzati**


## Guardiamo i pod: cosa ci raccontano davvero

```bash
oc get pods -n open-cluster-management-agent-addon
```


### üîπ Comunicazione con l‚ÄôHub

* `cluster-proxy-proxy-agent`
* `klusterlet-addon-workmgr`


> ‚ÄúQuesti sono i canali di comunicazione.
> Senza di loro l‚ÄôHub sarebbe cieco.‚Äù

---

### üîπ Altri addon

* `klusterlet-addon-search`
* `managed-serviceaccount-addon-agent`

üëâ non c‚Äôentrano direttamente con la policy che stai analizzando
üëâ ma dimostrano che **ogni funzionalit√† √® un addon separato**

---


# Fine





















In un ambiente **multicluster**, la governance serve a garantire che tutte le policy aziendali vengano rispettate **in modo coerente** su tutti i cluster, sia on-premise sia cloud. Non si tratta solo di sicurezza, ma anche di standard di sviluppo, resilienza, conformit√† regolatoria e gestione dei certificati.

* **Governance** = insieme di **regole, controlli e risoluzioni** che applicano gli standard su ogni cluster.
* RHACM fornisce un **framework centralizzato** per monitorare e correggere le violazioni delle policy.

**Esempio pratico**:
Se la tua azienda richiede che **tutti i namespace di produzione abbiano almeno un certo set di label e limiti di risorse**, RHACM pu√≤:

1. Controllare ogni cluster per verificare la conformit√†.
2. Generare eventi di violazione se qualche cluster non rispetta la regola.
3. Applicare eventuali correzioni automatiche (remediation).

---

# üéØ Use Cases principali

1. **Gestione della compliance multi-cluster**

   * RHACM controlla ogni cluster e applica policy uniformi.
   * Se un cluster non √® conforme, i **policy controller** possono correggerlo automaticamente.

2. **Verifica delle violazioni**

   * Policy built-in o custom verificano:

     * Sicurezza dei cluster
     * Installazione di operatori per compliance
     * Certificati in scadenza o non conformi (es. DNS mismatch)

3. **Supporto multi-ambiente**

   * Funziona su:

     * Data center
     * Private cloud
     * Public cloud

---

# üèóÔ∏è Componenti della governance RHACM

Governance in RHACM si divide tra **Hub** e **Managed clusters**. Ecco la struttura:


## **Componenti che girano sull‚ÄôHUB cluster**

### **1. Policy Propagator Controller**

√à il componente che si occupa di **distribuire la policy madre** ai cluster corretti e di **aggregarne lo stato**.

Lo puoi descrivere cos√¨:

> ‚ÄúLa policy root la scriviamo noi.
> Il propagator √® il postino intelligente che la copia nei namespace dell‚ÄôHub che rappresentano i cluster selezionati dal Placement.
> Inoltre legge lo stato di compliance che arriva dalle copie e lo riporta dentro la root policy, cos√¨ il sistema centrale sa chi rispetta le regole e chi no.
> Se ci sono automazioni collegate (PolicyAutomation), lui le avvia.‚Äù

Dettagli chiave da far capire:

* **Replica la policy root** nei namespace dell‚ÄôHub che ‚Äúrappresentano‚Äù i cluster gestiti
* **Osserva Placement, Binding e Automation**
* **Aggiorna lo status aggregato della root policy**
* **Avvia remediation automatiche o workflow di automazione**, se configurati

Ruolo riassunto in 3 parole:
üì¶ *Propaga, osserva, aggrega*

---

### **2. Governance Policy Add-On Controller**

Questo controller non copia le policy, ma **gestisce l‚Äôinstallazione dei controller di policy nei cluster remoti**.

Come dirlo in aula:

> ‚ÄúSe il propagator √® il postino, l‚ÄôAdd-On controller √® l‚Äôinstallatore degli strumenti di verifica.
> Lui prepara i cluster gestiti a poter ricevere e controllare le policy, installando i Policy Controller locali e assicurandosi che il pod `governance-policy-framework` sia attivo nel cluster.‚Äù

Dettagli chiave:

* Installa i **policy controller** sui cluster gestiti
* Gestisce il lifecycle del **Governance Policy Framework** (che poi gira nel cluster remoto)

Ruolo in 3 parole:
üõ†Ô∏è *Installa, abilita, gestisce*

---

## **Componenti che girano sui MANAGED cluster**

### **3. Governance Policy Framework Controller** (pod locale nel cluster gestito)

Questo √® il **cuore operativo nel cluster remoto**.
Non prende decisioni su dove applicare le policy: **le riceve, le sincronizza, le controlla, e invia i risultati all‚ÄôHub**.

> ‚ÄúNel Managed cluster abbiamo un agente che esegue i controlli per conto nostro.
> La policy non la leggono direttamente i controller dell‚ÄôHub: viene prima sincronizzata localmente e poi valutata qui.
> Questo agente contiene pi√π controller specializzati che mantengono allineata la policy e raccolgono gli eventi di compliance.‚Äù

---

### Controller interni al Governance Policy Framework:

#### **a. Spec Sync Controller**

> ‚ÄúAssicura che la policy replicata sia identica alla root policy definita sull‚ÄôHub.
> Se l‚ÄôHub cambia la spec, lui la aggiorna nel namespace locale del cluster.‚Äù

* **Sync direzione:** Hub ‚Üí Managed (spec ‚Üì)
* **Obiettivo:** coerenza del desired state

---

#### **b. Status Sync Controller**

> ‚ÄúRaccoglie i risultati dei Policy Controller locali (Configuration, Certificate, Operator, Gatekeeper‚Ä¶).
> Aggiorna lo status della policy nel cluster e lo invia all‚ÄôHub.
> Importante: non conserva storico, ma solo lo stato rilevante della policy attuale.‚Äù

* **Sync direzione:** Managed ‚Üí Hub (status ‚Üë)
* **Obiettivo:** reporting di compliance
* **Reset storico se policy viene ricreata**

---

#### **c. Template Sync Controller**

> ‚ÄúControlla gli oggetti definiti dentro i template della policy.
> Se qualcosa cambia nel cluster, aggiorna gli oggetti collegati ai template.‚Äù

* **Sync direzione:** bidirezionale sui template
* **Obiettivo:** mantenere le risorse dichiarate nella policy sempre allineate

---

#### **d. Gatekeeper Sync Controller** *(solo se OPA Gatekeeper √® usato)*

> ‚ÄúSe nel cluster usiamo OPA Gatekeeper, questo controller prende i risultati di audit delle constraint OPA e li registra come eventi di compliance ACM.‚Äù

* **Non sostituisce Gatekeeper**, ma lo integra
* **Converte audit OPA in eventi leggibili da RHACM**

---

# üìÑ Policy RHACM: struttura e funzionamento

Ogni **Policy** in RHACM richiede tre componenti principali:

1. **policy-templates**: definizione della policy, es. Namespace, ConfigMap, certificato
2. **Placement**: specifica i cluster (o gruppi) su cui applicare la policy
3. **PlacementBinding**: lega la policy al Placement scelto

### Esempio semplificato

```yaml
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-namespace
spec:
  remediationAction: inform
  policy-templates:
    - objectDefinition:
        kind: Namespace
        metadata:
          name: prod
```

* `remediationAction: inform` ‚Üí notifica le violazioni senza correggerle
* Altri valori possibili: `enforce` ‚Üí corregge automaticamente

---

# üîÅ Tipi di policy controllers

RHACM usa **diversi controller** per controllare e applicare le policy:

1. **Configuration Policy Controller**

   * Monitora risorse Kubernetes
   * Applica remediation (`inform` o `enforce`)
   * Pu√≤ installare operatori per compliance

2. **Certificate Policy Controller**

   * Controlla certificati in scadenza
   * Supporta inclusione/esclusione di namespace

3. **Policy Set Controller**

   * Gruppo di policy per applicarle insieme
   * Richiede PlacementBinding per determinare i cluster target

4. **Operator Policy Controller**

   * Installa e monitora operatori tramite OLM
   * Esempio: installare il Quay operator

---

# üß© Schema mentale RHACM Governance

```
          +-------------------------+
          |       HUB Cluster       |
          |-------------------------|
          | Governance Dashboard   |
          | Policy Propagator Ctrl |
          | Policy Add-on Ctrl     |
          +-----------+-------------+
                      |
                      v
         -----------------------------
        |      Managed Cluster        |
        |----------------------------|
        | Governance Policy Framework |
        |  - Spec Sync               |
        |  - Status Sync             |
        |  - Template Sync           |
        |  - Gatekeeper Sync         |
        -----------------------------
                      |
                      v
               Policy Enforcement
              (inform / enforce)
```

* Hub ‚Üí distribuisce policy
* Managed ‚Üí esegue policy, monitora e invia lo stato a hub
* Eventuali violazioni ‚Üí registrate nel dashboard

---

# ‚úÖ Pattern pratici da ricordare

1. **Policy ‚Äúmust have‚Äù vs ‚Äúinformative‚Äù**

   * `musthave`: la policy deve essere rispettata, altrimenti remediation automatica
   * `inform`: solo monitoraggio, senza modifiche

2. **Tolleranze e selettori nei Placement**

   * Permette di scegliere subset di cluster su cui applicare policy
   * Utile in ambienti eterogenei (dev, stage, prod)

3. **Policy set**

   * Per compliance normativa (es. PCI, NIST)
   * Esegue pi√π policy in parallelo in cluster selezionati

4. **Operator installation**

   * Policy controller pu√≤ installare operatori automaticamente
   * Esempio: OLM per gestire add-on operator

---



## Riepilogo componenti:

## Hub Cluster

1. **Governance Dashboard**

   * UI grafica + editor YAML
   * Visualizza:

     * Policy
     * Cluster violanti
     * Standard e controlli

2. **Policy Propagator Controller**

   * Replica le policy sugli **spazi dei namespace dei cluster** gestiti
   * Monitora Placement, PlacementBinding e PolicyAutomation
   * Aggiorna lo stato di compliance nel cluster hub

3. **Governance Policy Add-on Controller**

   * Installa e gestisce i **policy controller** nei managed cluster
   * Coordina il Governance Policy Framework Controller

---

## Managed Clusters

1. **Governance Policy Framework Controller**

   * Pod `governance-policy-framework`
   * Contiene i seguenti sottocontroller:

     * **Spec Sync**: sincronizza la policy dal cluster hub al namespace locale
     * **Status Sync**: monitora eventi e aggiorna lo stato nel cluster hub
     * **Template Sync**: aggiorna oggetti definiti nei template delle policy
     * **Gatekeeper Sync**: registra i risultati dei constraint audit di Gatekeeper

---

