
# üèõÔ∏è Governance in RHACM: concetto chiave

In un ambiente **multicluster**, la governance serve a garantire che tutte le policy aziendali vengano rispettate **in modo coerente** su tutti i cluster, sia on-premise sia cloud. Non si tratta solo di sicurezza, ma anche di standard di sviluppo, resilienza, conformit√† regolatoria e gestione dei certificati.

* **Governance** = insieme di **regole, controlli e risoluzioni** che applicano gli standard su ogni cluster.
* RHACM fornisce un **framework centralizzato** per monitorare e correggere le violazioni delle policy.

**Esempio pratico**:
Se la tua azienda richiede che **tutti i namespace di produzione abbiano almeno un certo set di label e limiti di risorse**, RHACM pu√≤:

1. Controllare ogni cluster per verificare la conformit√†.
2. Generare eventi di violazione se qualche cluster non rispetta la regola.
3. Applicare eventuali correzioni automatiche (remediation).

---

# üéØ Use Cases principali

1. **Gestione della compliance multi-cluster**

   * RHACM controlla ogni cluster e applica policy uniformi.
   * Se un cluster non √® conforme, i **policy controller** possono correggerlo automaticamente.

2. **Verifica delle violazioni**

   * Policy built-in o custom verificano:

     * Sicurezza dei cluster
     * Installazione di operatori per compliance
     * Certificati in scadenza o non conformi (es. DNS mismatch)

3. **Supporto multi-ambiente**

   * Funziona su:

     * Data center
     * Private cloud
     * Public cloud

---

# üèóÔ∏è Componenti della governance RHACM

Governance in RHACM si divide tra **Hub** e **Managed clusters**. Ecco la struttura:


## **Componenti che girano sull‚ÄôHUB cluster**

### **1. Policy Propagator Controller**

√à il componente che si occupa di **distribuire la policy madre** ai cluster corretti e di **aggregarne lo stato**.

Lo puoi descrivere cos√¨:

> ‚ÄúLa policy root la scriviamo noi.
> Il propagator √® il postino intelligente che la copia nei namespace dell‚ÄôHub che rappresentano i cluster selezionati dal Placement.
> Inoltre legge lo stato di compliance che arriva dalle copie e lo riporta dentro la root policy, cos√¨ il sistema centrale sa chi rispetta le regole e chi no.
> Se ci sono automazioni collegate (PolicyAutomation), lui le avvia.‚Äù

Dettagli chiave da far capire:

* **Replica la policy root** nei namespace dell‚ÄôHub che ‚Äúrappresentano‚Äù i cluster gestiti
* **Osserva Placement, Binding e Automation**
* **Aggiorna lo status aggregato della root policy**
* **Avvia remediation automatiche o workflow di automazione**, se configurati

Ruolo riassunto in 3 parole:
üì¶ *Propaga, osserva, aggrega*

---

### **2. Governance Policy Add-On Controller**

Questo controller non copia le policy, ma **gestisce l‚Äôinstallazione dei controller di policy nei cluster remoti**.

Come dirlo in aula:

> ‚ÄúSe il propagator √® il postino, l‚ÄôAdd-On controller √® l‚Äôinstallatore degli strumenti di verifica.
> Lui prepara i cluster gestiti a poter ricevere e controllare le policy, installando i Policy Controller locali e assicurandosi che il pod `governance-policy-framework` sia attivo nel cluster.‚Äù

Dettagli chiave:

* Installa i **policy controller** sui cluster gestiti
* Gestisce il lifecycle del **Governance Policy Framework** (che poi gira nel cluster remoto)

Ruolo in 3 parole:
üõ†Ô∏è *Installa, abilita, gestisce*

---

## **Componenti che girano sui MANAGED cluster**

### **3. Governance Policy Framework Controller** (pod locale nel cluster gestito)

Questo √® il **cuore operativo nel cluster remoto**.
Non prende decisioni su dove applicare le policy: **le riceve, le sincronizza, le controlla, e invia i risultati all‚ÄôHub**.

> ‚ÄúNel Managed cluster abbiamo un agente che esegue i controlli per conto nostro.
> La policy non la leggono direttamente i controller dell‚ÄôHub: viene prima sincronizzata localmente e poi valutata qui.
> Questo agente contiene pi√π controller specializzati che mantengono allineata la policy e raccolgono gli eventi di compliance.‚Äù

---

### Controller interni al Governance Policy Framework:

#### **a. Spec Sync Controller**

> ‚ÄúAssicura che la policy replicata sia identica alla root policy definita sull‚ÄôHub.
> Se l‚ÄôHub cambia la spec, lui la aggiorna nel namespace locale del cluster.‚Äù

* **Sync direzione:** Hub ‚Üí Managed (spec ‚Üì)
* **Obiettivo:** coerenza del desired state

---

#### **b. Status Sync Controller**

> ‚ÄúRaccoglie i risultati dei Policy Controller locali (Configuration, Certificate, Operator, Gatekeeper‚Ä¶).
> Aggiorna lo status della policy nel cluster e lo invia all‚ÄôHub.
> Importante: non conserva storico, ma solo lo stato rilevante della policy attuale.‚Äù

* **Sync direzione:** Managed ‚Üí Hub (status ‚Üë)
* **Obiettivo:** reporting di compliance
* **Reset storico se policy viene ricreata**

---

#### **c. Template Sync Controller**

> ‚ÄúControlla gli oggetti definiti dentro i template della policy.
> Se qualcosa cambia nel cluster, aggiorna gli oggetti collegati ai template.‚Äù

* **Sync direzione:** bidirezionale sui template
* **Obiettivo:** mantenere le risorse dichiarate nella policy sempre allineate

---

#### **d. Gatekeeper Sync Controller** *(solo se OPA Gatekeeper √® usato)*

> ‚ÄúSe nel cluster usiamo OPA Gatekeeper, questo controller prende i risultati di audit delle constraint OPA e li registra come eventi di compliance ACM.‚Äù

* **Non sostituisce Gatekeeper**, ma lo integra
* **Converte audit OPA in eventi leggibili da RHACM**

---

# üìÑ Policy RHACM: struttura e funzionamento

Ogni **Policy** in RHACM richiede tre componenti principali:

1. **policy-templates**: definizione della policy, es. Namespace, ConfigMap, certificato
2. **Placement**: specifica i cluster (o gruppi) su cui applicare la policy
3. **PlacementBinding**: lega la policy al Placement scelto

### Esempio semplificato

```yaml
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-namespace
spec:
  remediationAction: inform
  policy-templates:
    - objectDefinition:
        kind: Namespace
        metadata:
          name: prod
```

* `remediationAction: inform` ‚Üí notifica le violazioni senza correggerle
* Altri valori possibili: `enforce` ‚Üí corregge automaticamente

---

# üîÅ Tipi di policy controllers

RHACM usa **diversi controller** per controllare e applicare le policy:

1. **Configuration Policy Controller**

   * Monitora risorse Kubernetes
   * Applica remediation (`inform` o `enforce`)
   * Pu√≤ installare operatori per compliance

2. **Certificate Policy Controller**

   * Controlla certificati in scadenza
   * Supporta inclusione/esclusione di namespace

3. **Policy Set Controller**

   * Gruppo di policy per applicarle insieme
   * Richiede PlacementBinding per determinare i cluster target

4. **Operator Policy Controller**

   * Installa e monitora operatori tramite OLM
   * Esempio: installare il Quay operator

---

# üß© Schema mentale RHACM Governance

```
          +-------------------------+
          |       HUB Cluster       |
          |-------------------------|
          | Governance Dashboard   |
          | Policy Propagator Ctrl |
          | Policy Add-on Ctrl     |
          +-----------+-------------+
                      |
                      v
         -----------------------------
        |      Managed Cluster        |
        |----------------------------|
        | Governance Policy Framework |
        |  - Spec Sync               |
        |  - Status Sync             |
        |  - Template Sync           |
        |  - Gatekeeper Sync         |
        -----------------------------
                      |
                      v
               Policy Enforcement
              (inform / enforce)
```

* Hub ‚Üí distribuisce policy
* Managed ‚Üí esegue policy, monitora e invia lo stato a hub
* Eventuali violazioni ‚Üí registrate nel dashboard

---

# ‚úÖ Pattern pratici da ricordare

1. **Policy ‚Äúmust have‚Äù vs ‚Äúinformative‚Äù**

   * `musthave`: la policy deve essere rispettata, altrimenti remediation automatica
   * `inform`: solo monitoraggio, senza modifiche

2. **Tolleranze e selettori nei Placement**

   * Permette di scegliere subset di cluster su cui applicare policy
   * Utile in ambienti eterogenei (dev, stage, prod)

3. **Policy set**

   * Per compliance normativa (es. PCI, NIST)
   * Esegue pi√π policy in parallelo in cluster selezionati

4. **Operator installation**

   * Policy controller pu√≤ installare operatori automaticamente
   * Esempio: OLM per gestire add-on operator

---



## Riepilogo componenti:

## Hub Cluster

1. **Governance Dashboard**

   * UI grafica + editor YAML
   * Visualizza:

     * Policy
     * Cluster violanti
     * Standard e controlli

2. **Policy Propagator Controller**

   * Replica le policy sugli **spazi dei namespace dei cluster** gestiti
   * Monitora Placement, PlacementBinding e PolicyAutomation
   * Aggiorna lo stato di compliance nel cluster hub

3. **Governance Policy Add-on Controller**

   * Installa e gestisce i **policy controller** nei managed cluster
   * Coordina il Governance Policy Framework Controller

---

## Managed Clusters

1. **Governance Policy Framework Controller**

   * Pod `governance-policy-framework`
   * Contiene i seguenti sottocontroller:

     * **Spec Sync**: sincronizza la policy dal cluster hub al namespace locale
     * **Status Sync**: monitora eventi e aggiorna lo stato nel cluster hub
     * **Template Sync**: aggiorna oggetti definiti nei template delle policy
     * **Gatekeeper Sync**: registra i risultati dei constraint audit di Gatekeeper

---

