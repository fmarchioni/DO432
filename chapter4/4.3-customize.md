## Lezione â€“ Customizzare lo Observability Stack di RHACM

### Contesto della lezione

Questa lezione **segue** lâ€™installazione e la configurazione base dello *RHACM Observability Stack*. Gli studenti hanno giÃ  uno stack funzionante (Thanos, Alertmanager, Grafana) e ora imparano **come adattarlo a scenari reali di produzione**, tipici di ambienti **telco, multiâ€‘cluster, ZTPâ€‘driven**.

Lâ€™obiettivo non Ã¨ solo *come* configurare, ma *perchÃ©* farlo e *quando* Ã¨ la scelta corretta.

---

## Obiettivi didattici

Al termine della lezione lo studente sarÃ  in grado di:

* Comprendere **quali componenti dello stack di osservabilitÃ  sono customizzabili** in RHACM
* Scalare correttamente lo stack tramite `MultiClusterObservability`
* Distinguere e usare **recording rules** e **alerting rules**
* Aggiungere **custom metrics** (platform e user workload)
* Creare **custom alert multiâ€‘cluster**
* Estendere o creare **dashboard Grafana personalizzate**
* Integrare RHACM con **sistemi di alerting esterni** (Slack, PagerDuty, ecc.)

---

## 1. PerchÃ© customizzare lo Observability Stack

In ambienti di produzione (specialmente telco):

* Il numero di cluster Ã¨ elevato
* I query PromQL diventano costose
* Le soglie di alert variano per cluster / dominio
* I team NOC richiedono dashboard mirate

ðŸ‘‰ **La configurazione di default non basta**. RHACM fornisce gli strumenti per adattare lo stack senza rompere il modello hubâ€‘andâ€‘spoke.

---

## 2. MultiClusterObservability Custom Resource

Il CR `MultiClusterObservability` Ã¨ il **punto centrale di controllo** dello stack.

Permette di configurare:

* Retention delle metriche
* Storage per Thanos e Alertmanager
* Replica dei componenti
* Downsampling
* Intervallo di raccolta

### Esempio: scalare Thanos Receive

```yaml
apiVersion: observability.open-cluster-management.io/v1beta2
kind: MultiClusterObservability
metadata:
  name: observability
spec:
  enableDownsampling: true
  observabilityAddonSpec:
    enableMetrics: true
    interval: 30
  advanced:
    receive:
      replicas: 6
```

### Quando serve aumentare le repliche

* Fleet con **decine o centinaia di cluster**
* Metriche ad alta cardinalitÃ 
* Query lente in Grafana

ðŸ“Œ **Best practice telco**: scalare *prima* Thanos Receive, non Prometheus sui managed cluster.

---

## 3. Prometheus Rules: concetti chiave

Prometheus supporta due tipi di regole:

| Tipo            | Scopo                     |
| --------------- | ------------------------- |
| Recording Rules | Ottimizzare query costose |
| Alerting Rules  | Generare notifiche        |

In RHACM queste regole vengono valutate **centralmente** via Thanos Ruler.

---

## 4. Recording Rules

### PerchÃ© usarle

* Preâ€‘calcolano metriche costose
* Migliorano performance dei dashboard
* Rendono le query piÃ¹ leggibili

### Esempio

```yaml
- record: code:prometheus_http_requests_total:sum
  expr: sum by (code) (prometheus_http_requests_total)
  labels:
    env: stage
```

ðŸ‘‰ Questa metrica puÃ² essere riutilizzata in **piÃ¹ dashboard e alert** senza ricalcolare lâ€™espressione.

---

## 5. Alerting Rules

### Scopo

Definire **condizioni operative** che richiedono attenzione umana.

### Esempio

```yaml
- alert: HighRequestLatency
  expr: job:request_latency_seconds:mean5m{job="myjob"} > 0.5
  for: 10m
  keep_firing_for: 5m
  labels:
    severity: page
  annotations:
    summary: High request latency
```

ðŸ“Œ In ambienti telco, la clausola `for:` Ã¨ fondamentale per evitare *alert flapping*.

---

## 6. Metriche RHACM: default vs custom

### Metriche di default

* Provengono dai Prometheus dei managed cluster
* Sono filtrate tramite `observability-metrics-allowlist`
* **Non sono modificabili**

---

## 7. Custom Metrics

RHACM permette di aggiungere:

* **Platform metrics**
* **User workload metrics**

### Custom allowlist (hub)

```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: observability-metrics-custom-allowlist
  namespace: open-cluster-management-observability
data:
  metrics_list.yaml: |
    names:
      - node_memory_MemTotal_bytes
    recording_rules:
      - record: apiserver_request_duration_seconds:histogram_quantile_90
        expr: histogram_quantile(0.90,sum(rate(apiserver_request_duration_seconds_bucket{job="apiserver",verb!="WATCH"}[5m])) by (verb,le))
```

âš ï¸ La creazione del ConfigMap **riavvia il metricsâ€‘collector**.

---

## 8. Metriche da un singolo managed cluster

Per raccogliere metriche **da un solo cluster**:

* Applicare il ConfigMap nel namespace:
  `open-cluster-management-addon-observability`

ðŸ‘‰ Utile per:

* Cluster pilota
* Debug mirato
* Edge con risorse limitate

---

## 9. User Workload Metrics

Le metriche applicative sono definite **nel namespace dellâ€™applicazione**.

```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: observability-metrics-custom-allowlist
  namespace: monitored_namespace
data:
  uwl_metrics_list.yaml:
    names:
      - sample_metrics
```

ðŸ“Œ Approccio tipico DevOps: il team applicativo controlla *le proprie metriche*.

---

## 10. Custom Alerts in RHACM

### Dove vivono

* ConfigMap `thanos-ruler-custom-rules`
* Namespace: `open-cluster-management-observability`

### Esempio multiâ€‘cluster

```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: thanos-ruler-custom-rules
  namespace: open-cluster-management-observability
data:
  custom_rules.yaml: |
    groups:
    - name: cluster-health
      rules:
      - alert: ClusterCPUReq-70
        expr: sum(namespace_cpu:kube_pod_container_resource_requests:sum) by (clusterID,cluster)
              / sum(kube_node_status_allocatable{resource="cpu"}) by (clusterID,cluster) > 0.7
        for: 5s
        labels:
          severity: critical
```

ðŸ‘‰ Alert **fleetâ€‘wide**, non clusterâ€‘local.

---

## 11. Verifica degli alert

In Grafana:

* Explore â†’ Metric: `ALERTS`
* Filtro: `alertname`

ðŸ“Œ Questo Ã¨ il modo piÃ¹ rapido per validare una regola nuova.

---

## 12. Grafana Dashboards in RHACM

* Oltre 15 dashboard predefinite
* Dashboard OCP + RHACM
* Supporto filtro per cluster

Le definizioni sono nei ConfigMap con prefisso:

```
grafana-dashboard-*
```

---

## 13. Dashboard custom

Workflow consigliato:

1. Avviare una **Grafana developer instance**
2. Progettare dashboard via UI
3. Esportare JSON
4. Creare ConfigMap in RHACM

ðŸ“Œ Separare **design** e **deploy** Ã¨ fondamentale in ambienti regolati.

---

## 14. Forwarding verso sistemi esterni

RHACM usa Alertmanager per integrare:

* Slack
* Email
* PagerDuty
* Sistemi NOC

Configurazione tramite override del secret:

```
alertmanager-config
```

Esempio Slack (concettuale):

* route
* receivers
* template dei messaggi

---

## 15. Disabilitare alert da managed cluster

Per disabilitare lâ€™alert forwarding:

```yaml
metadata:
  annotations:
    mco-disable-alerting: "true"
```

ðŸ‘‰ Utile per:

* Cluster di test
* ZTP bootstrap
* Ambienti edge instabili

---

## Messaggi chiave da portare a casa

* RHACM Observability Ã¨ **centralizzato ma estensibile**
* Le recording rules sono essenziali per la scalabilitÃ 
* Gli alert devono essere **multiâ€‘cluster aware**
* Grafana Ã¨ parte della piattaforma, non un accessorio
* In ambienti telco, **meno alert ma migliori** Ã¨ sempre la scelta giusta

---

 