Perfetto, chiudiamo **in bellezza e in modalitÃ  â€œistruttore seniorâ€**.
Questa Ã¨ una **lezione di troubleshooting completa**, strutturata come la farei in aula con studenti avanzati, **orientata a RHACM + GitOps + ZTP**, e con un forte focus su *come ragiona un architetto quando qualcosa non funziona*.

---

# Troubleshooting RHACM Applications

## GitOps multicluster: **come capire *dove* sta il problema**

---

## Obiettivo della lezione

Al termine di questa sezione gli studenti devono essere in grado di:

* individuare **il livello in cui il problema avviene**
* scegliere **la console corretta** (RHACM vs Argo CD hub vs Argo CD managed)
* distinguere problemi di:

  * **Git**
  * **ApplicationSet**
  * **Placement**
  * **Argo CD**
  * **cluster runtime**
* applicare un **metodo sistematico**, non â€œtentativi casualiâ€

---

## 1. Il principio fondamentale del troubleshooting RHACM

### Prima regola (da scrivere a caratteri cubitali)

> **Non tutto Ã¨ un problema di Argo CD**

In RHACM un deploy GitOps attraversa **piÃ¹ piani**:

```
Git
 â†“
ApplicationSet
 â†“
Placement
 â†“
(Application generata)
 â†“
Argo CD
 â†“
OpenShift runtime
```

ğŸ‘‰ Il troubleshooting **non parte mai dal pod**

---

## 2. Topology View: il punto di partenza (sempre)

### PerchÃ© partire da qui

La **Topology view RHACM**:

* aggrega lo stato **multicluster**
* mostra:

  * ApplicationSet
  * Application
  * risorse
* indica **in quale cluster** câ€™Ã¨ il problema

ğŸ’¡ **Mental model per gli studenti**:

> â€œLa Topology view risponde alla domanda *DOVE* sta succedendo qualcosa di stranoâ€

---

### Cosa fare concretamente

1. Aprire lâ€™applicazione
2. Individuare:

   * cluster in errore
   * componente in errore
3. Cliccare sullâ€™icona
4. Leggere:

   * messaggio di errore
   * YAML effettivamente applicato

âš ï¸ Importante:

> La Topology **non mostra tutto**, ma ti dice **dove scavare**

---

## 3. Scegliere la console giusta (errore tipico da studenti)

### Push vs Pull: console diversa

| Modello  | Console Argo CD da usare    |
| -------- | --------------------------- |
| **Push** | Argo CD **hub cluster**     |
| **Pull** | Argo CD **managed cluster** |

ğŸ‘‰ Errore comune:

* guardare lâ€™Argo CD del hub
* quando si usa il Pull model
* e dire: â€œNon vedo nullaâ€

ğŸ’¡ Frase didattica:

> â€œSe stai usando il Pull model e guardi il hub, stai guardando il posto sbagliatoâ€

---

## 4. Applicazioni che **non vengono deployate affatto**

### Sintomo

* ApplicationSet presente
* Nessuna Application generata
* Oppure Application creata ma vuota

---

### Checklist sistematica

#### 1ï¸âƒ£ ApplicationSet

Controllare:

* `repoURL`
* `targetRevision`
* `path`

Errore classico:

```yaml
targetRevision: prod   # branch inesistente
```

ğŸ‘‰ Risultato:

* ApplicationSet ok
* Application in errore

---

#### 2ï¸âƒ£ Accesso al repository Git

Domande da farsi:

* repository privato?
* token scaduto?
* CA privata mancante?

Errore tipico:

> x509: certificate signed by unknown authority

ğŸ‘‰ **Non Ã¨ un problema di RHACM**
ğŸ‘‰ Ãˆ **configurazione Argo CD**

---

#### 3ï¸âƒ£ Placement

Controllare:

```bash
oc get placement -n openshift-gitops
```

E poi:

```bash
oc describe placement myapp-placement -n openshift-gitops
```

Guardare:

* quanti cluster sono selezionati
* se sono **zero**, lâ€™app non verrÃ  mai deployata

ğŸ’¡ Messaggio chiave:

> â€œSe il Placement non seleziona cluster, lâ€™applicazione non esisteâ€

---

## 5. Applicazioni **OutOfSync**

### Cosa significa davvero OutOfSync

> â€œLo stato del cluster Ã¨ diverso da quello in Gitâ€

Cause tipiche:

* modifica manuale con `oc edit`
* hotfix fatto â€œsolo per provareâ€
* drift non sanato

---

### Comportamento di default

Se:

```yaml
selfHeal: false
```

Argo CD:

* segnala il drift
* **non lo corregge**

---

### Soluzione (GitOps vero)

Abilitare:

```yaml
syncPolicy:
  automated:
    prune: true
    selfHeal: true
```

ğŸ’¡ Frase da architetto:

> â€œIn GitOps, se modifichi il cluster a mano, stai facendo debuggingâ€¦ non deployâ€

---

## 6. Applicazioni deployate ma **non funzionanti**

Qui entriamo nel **runtime OpenShift**.

---

### Stato: Not Deployed / OutOfSync

Tipico caso:

* YAML errato
* campo non previsto dalla CRD

Esempio:

* API version sbagliata
* campo obsoleto

ğŸ‘‰ RHACM segnala
ğŸ‘‰ OpenShift rifiuta

ğŸ’¡ Azione:

* cliccare sullâ€™icona
* leggere **lâ€™errore del server API**
* correggere **nel repo Git**

---

### Stato: Pending

Il cluster ha accettato la risorsa, ma:

* PVC senza storage class
* Deployment senza risorse disponibili
* Pod in attesa

ğŸ‘‰ Qui **Argo CD non câ€™entra piÃ¹**

Strumenti:

```bash
oc describe pod
oc describe pvc
oc get events
```

---

### Stato: Error

Tipicamente:

* probe fallite
* crashloop
* config errata

ğŸ‘‰ Ãˆ un **problema applicativo**

ğŸ’¡ Messaggio forte:

> â€œGitOps non corregge unâ€™applicazione che non sa partireâ€

---

## 7. Problemi specifici OpenShift GitOps + RHACM

### CA privata mancante

Sintomo:

* impossibile clonare repo HTTPS
* errore TLS

Soluzione:

* ConfigMap con CA
* mount in Argo CD

ğŸ‘‰ Problema **di integrazione**, non di applicazione

---

### Hub Argo CD sovraccarico (Push model)

Scenario reale:

* decine / centinaia di cluster
* un solo Argo CD
* CPU / memoria insufficienti

Sintomi:

* sync lenti
* errori intermittenti

Soluzione:

* aumentare risorse Argo CD
* oppure:

> â€œPassare al Pull modelâ€

---

## 8. Metodo di troubleshooting consigliato (da memorizzare)

### Ordine corretto

1. **Topology RHACM**
2. **Placement**
3. **ApplicationSet**
4. **Argo CD corretto (hub o managed)**
5. **OpenShift runtime**
6. **Applicazione**

Mai:
âŒ partire dai pod
âŒ modificare risorse a mano â€œper provareâ€

---

## 9. Quando tutto fallisce: must-gather

Ultimo step, non il primo.

```bash
oc adm must-gather
```

Serve quando:

* problema non riproducibile
* bug sospetto
* supporto Red Hat

ğŸ’¡ Frase da chiusura:

> â€œIl must-gather non serve a capire, serve a dimostrareâ€

---

## Messaggi finali da lasciare agli studenti

1. **RHACM non nasconde Argo CD, lo orchestra**
2. **GitOps non elimina il troubleshooting, lo struttura**
3. **Placement sbagliato = applicazione fantasma**
4. **Pull model: guarda sempre il cluster giusto**
5. **Se non Ã¨ in Git, non Ã¨ reale**
6. **Debug â‰  deploy**

---

 
