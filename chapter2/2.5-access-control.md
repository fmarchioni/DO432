
---

# Lezione: Configuring Access Control for Multicluster Management

**Obiettivo:** In questa sessione vediamo come configurare l'Access Control in RHACM

* I **Cluster** sono le singole filiali (Roma, Milano, Parigi).
* I **Cluster Sets** sono le Regioni o Divisioni (Divisione Italia, Divisione Francia).
* I **Roles** sono i badge dei dipendenti (chi puÃ² entrare dove).
* I **Placements** sono i criteri automatici per inviare risorse (es. "Manda queste forniture a tutte le filiali che hanno piÃ¹ di 100 dipendenti").

---

## 1. Cluster Sets: Creare i Confini 

 
"Immaginate di gestire 100 cluster. Se li mettiamo tutti in un unico elenco piatto, Ã¨ il caos. Se do a Mario i permessi di 'Admin', lui diventa Admin su *tutto*. Questo Ã¨ pericoloso.
In RHACM, la risorsa base per risolvere questo problema Ã¨ il **ManagedClusterSet**.
Pensate al Cluster Set come a un **recinto logico**. Non cambia il cluster, ma ci permette di dire: 'Questi 3 cluster appartengono alla Divisione Sviluppo'."

**Dimostrazione Pratica (Console):**

1. Andate su **Infrastructure** -> **Clusters**.
2. Cliccate sulla tab **Cluster sets**.

Notate il link a Submariner: questo Ã¨ un argomento non strettamente collegato al nostro corso, ma solo per darvi piÃ¹ contesto, Ã¨ uno strumento che consente di collegare via network piÃ¹ clusters openshift: mentre RHACM nasce per gestire cluster, non per collegarli in rete.
Se voglio che i cluster si parlino tra loro, allora abilito Submariner

3. **Azione:** Cliccate "Create cluster set".
* Nome: `developments`.


4. Aggiungiamo il **managed cluster**

> **Concetto Chiave per gli studenti:** "Notate che il cluster ora fa parte di un set. Un cluster puÃ² appartenere a *piÃ¹* set? SÃ¬, ma per ora manteniamo la struttura semplice: un cluster, un set primario per segregare gli ambienti."

---

## 2. RHACM Roles & Permissions: Chi puÃ² fare cosa? (I Badge)

**Spiegazione Discorsiva:**
"Ora che abbiamo creato il recinto (`development`), dobbiamo stabilire chi puÃ² entrarci. Nel bookshelf il binding di utenti o gruppi al clusterset viene fatto da CLI ma si puÃ² fare piÃ¹ semplicemente da console Web

Selezioniamo il ClusterSet->User Management

Ad esempio attribuiamo all'utente developer il ruolo di admin

Notate che sono disponibili diversi ruoli:
 

**I Ruoli RHACM:**

* **admin:** Pieno controllo sui cluster nel set (puÃ² cancellare, aggiornare).
* **view:** PuÃ² solo guardare (ottimo per gli auditor).
* **bind:** consentire a un team di **bindare un cluster set a un namespace**


---

## 3. Placements: L'Automazione Intelligente (Il Selettore)

**Spiegazione Discorsiva:**
"Finora abbiamo capito come si creano dei sets di clusters chiamati ClusterSets. Immaginiamo come il DB dei clusters.
Per operare su questo DB di cluster si usa un componente fondamentale che Ã¨ il Placement

**Vai su bookshelf**

Il Placement non Ã¨ altro che una **Query SQL per i vostri clusterset**.
Invece di dire 'Installa questa app su ClusterSet A', noi diciamo 'Installa questa app su tutti i clusterset che hanno l'etichetta `env=production`'.
Allo stesso modo, se applico una Policy, la faccio non direttamente sul ClusterSet ma attraverso un Placement.
In pratica, mentre i ClusterSet sono divisioni **logiche** (produzione, sviluppo) che generalmente non cambiano, io posso creare dei Placement
ogni volta diversi, semplicemente usando labels o altri filtri per selezionare una parte di ClusterSets

Adesso osservate il Placement e ditemi: qual'Ã¨ la parte piÃ¹ importante di tutti secondo voi?

````yaml
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: placement1
  namespace: default
spec:
  numberOfClusters: 3 
  clusterSets: 2
    - dev
    - stage
  predicates: 
    - requiredClusterSelector:
        labelSelector: 
          matchLabels:
            purpose: test
        claimSelector: 
          matchExpressions:
            - key: region.open-cluster-management.io
              operator: In
              values:
                - us-west-1
````

il namespace! Un Placement, per poter essere coerente con le regole di AccessControl (RBAC) deve essere legato ad un namespace

PerchÃ©?

perchÃ¨ il placement deve avvenire in un perimetro consentito

Il namespace:

* determina chi puÃ² usare questo Placement
* determina quali ClusterSet sono visibili

Di tutto questo ci accorgeremo tra poco appena andremo a piazzare delle Policy o della Applicazioni su un clusterset.
Vai su ClusterSet->Overview e vai su **namespace**

Questa Ã¨ la chiave di tutto: "Un ClusterSet da solo non basta per poter gestire i cluster. Per poterli usare davvero, il ClusterSet deve essere "â€œattaccatoâ€ a un namespace.



Nel nostro esempio in alto, **Placement** NON vede tutti i cluster

vede solo:

cluster appartenenti ai ClusterSet dev e stage

e bindati al namespace default

Nello specifico, il Placement di esempio contiene anche dei **Predicates** che sono dei filtri che selezionano i clusters con la label "purpose: test" che mettiamo noi come amministratori di RHACM ed anche un claimSelector, che tipicamente sono aggiunti nelle installazioni managed come chiave/valori (es di AWS)


### ğŸ”¹ Taints & Tolerations

Concetto potentissimo per ambienti regulated.

Uso reale:

* cluster â€œspecialiâ€
* ambienti temporaneamente esclusi
* nodi in manutenzione

Collegamento ZTP:

* i taints spesso arrivano **da day-0 / site config**

---

### ğŸ”¹ Prioritizers

Meno usati, ma:

* **ottimi per domande avanzate**
* utili per:

  * capacity aware placement
  * edge con risorse eterogenee

---

## 6ï¸âƒ£ PlacementDecision (da sapere *come funziona*, non solo cosâ€™Ã¨)

Punti chiave:

* generata automaticamente
* **Ã¨ lo stato reale della selezione**
* tutto ciÃ² che â€œconsumaâ€ placement guarda qui

ğŸ¯ Concetto importante per GitOps:

> **Non si modifica mai a mano**
> (se lo fai, il controller lo corregge)


# Fine
















ğŸ“Œ Placement = decisione operativa locale al namespace

Se domani accendete un nuovo cluster e gli mettete l'etichetta `env=production`, RHACM lo rileverÃ  automaticamente e ci installerÃ  l'applicazione senza che voi muoviate un dito."

**Dimostrazione Pratica (Console):**

1. Andate su **Governance** (o Applications, i Placement si usano ovunque). Creiamone uno semplice dalla UI o via YAML per far vedere la logica.
2. Mostrate come etichettare un cluster:
* Tornate a **Infrastructure** -> **Clusters**.
* Sul cluster, cliccate "Edit labels".
* Aggiungete: `environment=dev`.


3. Create una regola di **Placement** (potete simularla creando una "Application" veloce o mostrando la risorsa YAML `Placement`):
* Mostrate il campo `predicates` o `matchLabels`.
* Fate vedere che se scrivete `matchLabels: environment: dev`, il contatore dei cluster selezionati passa da 0 a 1.



> **Nota Fondamentale:** "I Placement moderni (API v1beta1) possono anche selezionare in base ai *ClusterSets*. Potete dire: 'Seleziona tutti i cluster con label `region=eu` MA SOLO se sono dentro il ClusterSet `development-clusters`'. Questo Ã¨ il massimo della sicurezza e dell'automazione."

---

## Riepilogo Visuale alla Lavagna (o Slide finale)

Per chiudere il cerchio, disegnate o mostrate questa gerarchia:

1. **Cluster:** L'entitÃ  fisica.
2. **Label:** Il cartellino sul cluster (`env=dev`).
3. **Cluster Set:** Il recinto di sicurezza.
4. **Placement:** Il robot che guarda i cartellini (Label) ma non puÃ² scavalcare il recinto (Cluster Set) se non autorizzato.

---

### Passo Successivo

Ti piacerebbe che preparassi un file **YAML di esempio (un Lab Sheet)** da distribuire agli studenti, contenente i comandi esatti `oc` per creare un Utente, un ClusterSet e un Binding, cosÃ¬ possono fare copia-incolla mentre spieghi?






## 1ï¸âƒ£ Modello mentale da chiarire subito agli studenti

Prima ancora delle risorse:

> **In RHACM lâ€™accesso NON Ã¨ â€œuser â†’ clusterâ€, ma â€œuser â†’ namespace â†’ cluster set â†’ clusterâ€.**

Se questo concetto passa, tutto il resto Ã¨ naturale.

---

## 2ï¸âƒ£ Core building blocks (da conoscere *a memoria*)

### ğŸ”¹ ManagedCluster

CR che rappresenta **un cluster gestito** (on-prem, AWS, Azure, ecc.)

Parametri importanti lato access control:

* `metadata.name`
* `spec.taints` â†’ usatissimi per:

  * escludere cluster sensibili
  * ambienti speciali (GPU, prod, regulated)

âš ï¸ Tipico errore:

> pensare che lâ€™RBAC agisca direttamente sul ManagedCluster â†’ **NO**, passa sempre dai cluster set.

---

### ğŸ”¹ ManagedClusterSet

Ãˆ **il vero perimetro di sicurezza multicluster**.

Cose fondamentali:

* Un cluster **puÃ² appartenere a un solo cluster set**
* Ãˆ identificato dal label:

  ```
  cluster.open-cluster-management.io/clusterset=<name>
  ```

Cluster set **speciali** (da spiegare bene):

| ClusterSet | Scopo                   | Modificabile |
| ---------- | ----------------------- | ------------ |
| `default`  | fallback                | âŒ            |
| `global`   | include tutti i cluster | âŒ            |

ğŸ‘‰ In ambienti ZTP:

* spesso **1 cluster set = 1 dominio operativo**

  * es. `edge-prod`, `edge-stage`, `core-dc`

---

### ğŸ”¹ ManagedClusterSetBinding

**La risorsa piÃ¹ sottovalutata ma piÃ¹ importante per RBAC.**

> â€œBinding = ponte tra sicurezza OpenShift e sicurezza ACMâ€

* Namespace-scoped
* Collega:

  ```
  Namespace â†’ ManagedClusterSet
  ```

ğŸ’¡ Regola dâ€™oro:

> **Se un utente ha accesso al namespace, ha accesso al cluster set bindato.**

In GitOps:

* questo CR **vive nel repo**
* Ã¨ parte del modello â€œsecurity as codeâ€

---

## 3ï¸âƒ£ Namespace: il vero boundary di sicurezza

Spiega bene che:

* RHACM **riusa il modello RBAC di OpenShift**
* tutto passa dai **namespace**

Pattern tipico enterprise:

```
ns-team-a
 â”œâ”€ ManagedClusterSetBinding (team-a-clusters)
 â”œâ”€ Placement
 â”œâ”€ Applications / Policies
```

ğŸ‘‰ ZTP + GitOps:

* ogni team / dominio ha:

  * **repo**
  * **namespace**
  * **cluster set**

---

## 4ï¸âƒ£ Ruoli RHACM da conoscere davvero (non solo elencare)

### ğŸ” Ruoli â€œda corsoâ€ (quelli che contano)

#### ğŸ”¸ open-cluster-management:cluster-manager-admin

* **superuser ACM**
* puÃ² importare cluster
* tipicamente:

  * platform team
  * pochi utenti

---

#### ğŸ”¸ managedclusterset:admin:<name>

ğŸ‘‰ **IL ruolo enterprise per eccellenza**

Consente:

* gestione cluster del set
* clusterclaims
* clusterdeployments
* clusterpool

ğŸ¯ Caso Telecom:

> â€œogni BU controlla il suo perimetro, senza vedere gli altriâ€

---

#### ğŸ”¸ managedclusterset:view:<name>

Perfetto per:

* audit
* security
* compliance

ğŸ’¡ Ottimo esempio didattico:

> â€œaccesso in sola lettura allâ€™intero edgeâ€

---

#### ğŸ”¸ managedclusterset:bind:<name>

Ruolo **spesso dimenticato** ma cruciale.

Serve per:

* consentire a un team di **bindare un cluster set a un namespace**

âš ï¸ Senza questo ruolo:

* il GitOps pipeline **fallisce**

---

## 5ï¸âƒ£ Placement: access control â€œdinamicoâ€

### ğŸ”¹ Placement (namespace-scoped)

Ãˆ:

* **un selettore dinamico di cluster**
* usato da:

  * Applications
  * Policies
  * ZTP day-2

Prerequisiti RBAC:

* admin sul namespace
* admin sul cluster set

---

### ğŸ”¹ Predicates

Da collegare mentalmente a:

* **policy generator**
* **ZTP site labels**
* **cluster claims**

Filtri tipici:

* `labelSelector`
* `claimSelector`
* `numberOfClusters`

ğŸ’¡ ZTP insight:

> Le claim (`region`, `cpu-arch`, ecc.) sono spesso generate automaticamente durante ZTP.

---

### ğŸ”¹ Taints & Tolerations

Concetto potentissimo per ambienti regulated.

Uso reale:

* cluster â€œspecialiâ€
* ambienti temporaneamente esclusi
* nodi in manutenzione

Collegamento ZTP:

* i taints spesso arrivano **da day-0 / site config**

---

### ğŸ”¹ Prioritizers

Meno usati, ma:

* **ottimi per domande avanzate**
* utili per:

  * capacity aware placement
  * edge con risorse eterogenee

---

## 6ï¸âƒ£ PlacementDecision (da sapere *come funziona*, non solo cosâ€™Ã¨)

Punti chiave:

* generata automaticamente
* **Ã¨ lo stato reale della selezione**
* tutto ciÃ² che â€œconsumaâ€ placement guarda qui

ğŸ¯ Concetto importante per GitOps:

> **Non si modifica mai a mano**
> (se lo fai, il controller lo corregge)

---

## 7ï¸âƒ£ Collegamento esplicito con ZTP & GitOps (QUI ti faranno domande)

Devi essere pronto a dire:

* ZTP:

  * crea cluster
  * assegna labels / claims
  * inserisce il cluster nel cluster set

* GitOps:

  * usa namespace + binding
  * applica placement
  * non ha bisogno di conoscere i singoli cluster

ğŸ“Œ Frase â€œda esameâ€:

> *â€œIn RHACM lâ€™access control Ã¨ dichiarativo, versionato e applicato indirettamente tramite namespace, cluster set e placement.â€*

---

## 8ï¸âƒ£ Errori tipici da anticipare agli studenti

1. âŒ dare accesso diretto ai ManagedCluster
2. âŒ dimenticare il ManagedClusterSetBinding
3. âŒ usare `global` per tutto
4. âŒ mischiare team diversi nello stesso namespace
5. âŒ pensare che Placement sia solo per applicazioni (NO, anche policy e ZTP)

---

## 9ï¸âƒ£ Mini-checklist pre-corso (per te)

Prima di entrare in aula, assicurati di:

* saper creare **a mano**:

  * cluster set
  * binding
  * placement
* saper spiegare:

  * perchÃ© `global` Ã¨ pericoloso
  * perchÃ© il namespace Ã¨ il vero confine
* avere **1 esempio GitOps completo**:

  * repo â†’ namespace â†’ binding â†’ placement

---

