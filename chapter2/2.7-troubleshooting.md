# ğŸ§  Modello mentale fondamentale (da chiarire subito)

> **In RHACM NON stai â€œdebuggando un clusterâ€, ma una relazione distribuita Hub â†” Managed Cluster.**

Ogni problema multicluster ricade SEMPRE in una di queste 4 categorie:

1. **ConnettivitÃ **
2. **Trust (certificati / CA / tempo)**
3. **Agenti ACM (klusterlet & controller)**
4. **Stato dichiarativo incoerente (CR â‰  realtÃ )**

Se gli studenti imparano a classificare il problema prima di scavare, hanno giÃ  vinto metÃ  debugging.

---

# 1ï¸âƒ£ Troubleshooting fase â€œcluster creation / importâ€ (Day-0)

## ğŸ”¹ Checklist rapida (da proiettare in slide)

Quando un cluster **non compare / non si registra**:

| Categoria | Verifica                 |
| --------- | ------------------------ |
| Network   | 6443 + 443 bidirezionali |
| DNS       | API hub â†” API managed    |
| TLS       | CA trust reciproco       |
| Time      | chrony / NTP             |
| Images    | pull secret / registry   |

ğŸ‘‰ **90% dei problemi di import sono qui**.

---

## ğŸ”¸ Network (classico problema multicluster)

Punto chiave:

* **non basta che il managed cluster raggiunga lâ€™hub**
* **anche lâ€™hub deve raggiungere il managed**

ğŸ’¡ In ambienti enterprise:

* firewall stateful
* proxy
* NAT asimmetrici

Frase utile in aula:

> â€œSe Ã¨ un problema di rete, ACM non Ã¨ rotto: sta facendo il suo lavoro.â€

---

## ğŸ”¸ TLS e CA (problema tipico ambienti disconnessi)

Scenario classico:

* CA interna
* certificati custom
* trust non allineato

Cosa ricordare:

* **hub e managed devono fidarsi a vicenda**
* CA deve stare:

  * nel trust bundle
  * nei componenti che parlano API

ğŸ‘‰ Collegamento diretto a ZTP:

* se sbagli qui, **ZTP fallisce silenziosamente**

---

## ğŸ”¸ Time drift (sottovalutato ma micidiale)

Se vedi:

* join intermittente
* lease che scade

ğŸ‘‰ **pensa subito a NTP**

RHACM usa:

* lease
* certificati
* token temporizzati

ğŸ“Œ Regola dâ€™oro:

> *â€œSe il tempo non Ã¨ sincronizzato, il cluster Ã¨ â€˜schizofrenicoâ€™.â€*

---

## ğŸ”¸ Pull secret / immagini

Tipico ambiente Telecom:

* **disconnesso**
* registry interno
* mirroring

Se il managed cluster:

* non pulla immagini ACM
* gli agenti non partono

ğŸ‘‰ il cluster **non si registrerÃ  mai**

---

# 2ï¸âƒ£ Import controller (Hub side)

Quando la creazione/import **si blocca lato hub**, devi guardare:

### ğŸ”¹ managedcluster-import-controller-v2

Namespace:

```
multicluster-engine
```

Label:

```
app=managedcluster-import-controller-v2
```

Comandi da sapere **a memoria**:

```bash
oc get pods -n multicluster-engine \
  -l app=managedcluster-import-controller-v2

oc logs -n multicluster-engine \
  -l app=managedcluster-import-controller-v2
```

ğŸ¯ Insight didattico:

> Se il controller non crea la secret di import, **il problema NON Ã¨ nel managed cluster**.

---

## ğŸ”¸ Import Secret mancante

Per ogni cluster:

```
namespace = <cluster-name>
secret = <cluster-name>-import
```

Se manca:

* controller crashato
* permessi
* errore di comunicazione

ğŸ‘‰ **GitOps non câ€™entra nulla qui**
ğŸ‘‰ sei ancora in **Day-0**

---

# 3ï¸âƒ£ Klusterlet: IL CR PIÃ™ IMPORTANTE DA SAPER LEGGERE

Se câ€™Ã¨ **una sola risorsa** da insegnare a leggere bene, Ã¨ questa.

## ğŸ”¹ Klusterlet (sul managed cluster)

Condizioni chiave:

* `RegistrationDesiredDegraded`
* `WorkDesiredDegraded`

Devono essere:

```
status: False
```

Se sono `True`:

* agenti non partiti
* immagini non pullate
* errori di config

ğŸ’¡ Frase â€œda corsoâ€:

> â€œSe il klusterlet Ã¨ degradato, tutto il resto Ã¨ rumore.â€

---

# 4ï¸âƒ£ Pending Import (cluster giÃ  usato)

Problema **100% multicluster**, impossibile in single cluster.

Scenario:

* cluster giÃ  attaccato a un altro hub
* detach incompleto
* risorse ACM rimaste

Sintomo:

* import **Pending** per sempre

Soluzione:

* cleanup totale:

  * klusterlet
  * namespace agent
  * CRD ACM

ğŸ¯ Punto importante:

> **Un cluster puÃ² avere UN solo hub.**
> ACM non perdona i detach sporchi.

---

# 5ï¸âƒ£ ManagedCluster in stato Error / Unknown

## ğŸ”¹ ManagedCluster (hub side)

Ãˆ la **fonte di veritÃ ** per lo stato globale.

Condizione piÃ¹ importante:

```
ManagedClusterConditionAvailable
```

Se:

* `Unknown`
* `False`

ğŸ‘‰ **non andare subito sui workload**
ğŸ‘‰ torna al klusterlet

---

## ğŸ”¸ Caso tipico: Lease Update Stopped

Messaggio:

```
Registration agent stopped updating its lease
```

Cause tipiche:

* rete instabile
* firewall
* proxy
* MTU

Qui ACM sta dicendo:

> â€œIo non sento piÃ¹ il cluster, non so se Ã¨ vivo o morto.â€

---

# 6ï¸âƒ£ Stato che flappa: Ready â†” Unknown

Problema **tipico edge / WAN**.

Default:

* leaseDurationSeconds = 60
* retry = 5
* grace period = 5 minuti

Puoi:

* **aumentare leaseDurationSeconds**

Esempio:

```yaml
spec:
  leaseDurationSeconds: 120
```

ğŸ‘‰ Grace period = 10 minuti

ğŸ’¡ Insight importante:

> Questo NON risolve il problema di rete,
> ma evita falsi positivi operativi.

---

# 7ï¸âƒ£ Collegamento diretto con ZTP & GitOps

Qui devi essere molto chiaro in aula:

### ZTP

* dipende da:

  * import stabile
  * klusterlet sano
  * lease affidabile

Se vedi:

* policy non applicate
* CGU bloccate
* site config ignorate

ğŸ‘‰ **il problema Ã¨ quasi sempre prima**

---

### GitOps

* GitOps **non crea la connessione**
* GitOps **assume che il cluster sia Ready**

ğŸ“Œ Frase chiave:

> â€œGitOps non ripara cluster rotti. GitOps orchestra cluster sani.â€

---

# 8ï¸âƒ£ Sequenza corretta di troubleshooting (da insegnare)

**Ordine corretto (sempre):**

1. Network / DNS / TLS
2. Import controller (hub)
3. Import secret
4. Klusterlet (managed)
5. ManagedCluster status
6. Placement / policy / GitOps

âŒ Saltare passi = perdere ore

---

# 9ï¸âƒ£ Mini-checklist â€œda Telecomâ€

Se ti fanno domande avanzate, puoi rispondere cosÃ¬:

* â€œIn ambienti disconnessi, il **pull delle immagini** Ã¨ il primo sospettatoâ€
* â€œSe il cluster flappa, **non Ã¨ ACM**, Ã¨ la WANâ€
* â€œSe ZTP non applica policy, **il cluster non Ã¨ davvero Ready**â€
* â€œIl klusterlet Ã¨ il mio primo comando di debugâ€

---
 
