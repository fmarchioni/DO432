# ğŸ§  Modello mentale fondamentale (da chiarire subito)


Ecco una lezione discorsiva, strutturata come una guida "da campo" per il troubleshooting. L'obiettivo Ã¨ trasformare quella lista di controlli tecnici in una narrazione logica che guida gli studenti attraverso un processo investigativo.

---

# Lezione: L'Arte del Troubleshooting in RHACM

**Introduzione:**
"Bene ragazzi, abbiamo visto come le cose *dovrebbero* funzionare. Ma siamo onesti: nel mondo reale, le cose si rompono. Reti che cadono, certificati che scadono, firewall zelanti.
In questa sessione, non leggeremo il manuale delle istruzioni. Impareremo a fare i **Detective**.
Quando un cluster non appare nella console, o appare come 'Unknown', dobbiamo avere una checklist mentale. Red Hat fornisce una documentazione eccellente e un comando salvavita chiamato `must-gather` (che Ã¨ la nostra scatola nera da inviare al supporto), ma prima di arrivare lÃ¬, vediamo cosa possiamo risolvere noi."

Divideremo i problemi in tre grandi famiglie:

1. **Il cluster non nasce (Creation Failures).**
2. **Il cluster non entra (Import Failures).**
3. **Il cluster c'Ã¨ ma sta male (Status Issues).**

---

## 1. Il Primo Muro: Creation Failures (La ConnettivitÃ )

"Immaginate di aver appena cliccato 'Create Cluster'. Passa il tempo, ma il cluster non chiama casa. Di solito, il problema Ã¨ nelle fondamenta."

**La Checklist dei "Fondamentali":**

* **Il Telefono (Rete e Porte):**
"Sembra banale, ma Ã¨ il colpevole numero uno. L'Hub e il Managed Cluster devono parlarsi.
Ricordatevi due numeri: **443** e **6443**. Queste porte TCP devono essere aperte in *entrambe* le direzioni. Se c'Ã¨ un firewall in mezzo che blocca la 6443, l'Hub non potrÃ  mai dare ordini all'API server del cluster remoto."
* **L'Indirizzo (DNS):**
"Le porte sono aperte, ma sanno *chi* chiamare? I cluster devono risolvere i nomi DNS dei rispettivi API Endpoint. Se il DNS non funziona, Ã¨ come avere il numero di telefono ma non sapere a chi appartiene."
* **La Carta d'IdentitÃ  (Certificati):**
"Qui cascano in molti. Se usate una **Custom CA** (Certificate Authority) aziendale, i cluster devono fidarsi di quella CA. Se il certificato dell'API endpoint non Ã¨ fidato dalla controparte, la connessione verrÃ  rifiutata subito. Ãˆ come mostrare un documento scaduto in aeroporto."
* **L'Orologio (NTP/Chrony):**
"Immaginate di dare appuntamento a qualcuno alle 5:00, ma il suo orologio segna le 3:00. Non vi incontrerete mai. I cluster devono avere il tempo sincronizzato (configurate `chrony`). Se c'Ã¨ troppa deriva temporale, i certificati e i token sembreranno invalidi."
* **Il Biglietto d'Ingresso (Pull Secret):**
"Il nuovo cluster deve scaricare le immagini di RHACM dal registry Red Hat. Se non avete configurato il **Pull Secret** globale nel namespace del cluster, lui proverÃ  a bussare alla porta del registry Red Hat e verrÃ  rimbalzato."

---

## 2. Il Muro Intermedio: Import Failures (La Logica)

"Mettiamo che la rete sia a posto. Eppure, l'importazione fallisce. Qui dobbiamo guardare i 'motori' di RHACM."

```
oc login -u admin -p redhatocp   https://api.ocp4.example.com:6443
```


**Sull'Hub (Il "Cervello"):**

* **L'Import Controller:** "Andate nel namespace `multicluster-engine`. LÃ¬ vive un pod chiamato `managedcluster-import-controller`. Lui Ã¨ l'operaio che gestisce le importazioni. Sta funzionando? Guardate i log (`oc logs`). Se lui Ã¨ in crash, nulla funzionerÃ ."

```
oc get pods -n multicluster-engine -l app=managedcluster-import-controller-v2

oc logs -n multicluster-engine  -l app=managedcluster-import-controller-v2
```

* **Il secret di Importazione:** "Per ogni cluster gestito, RHACM crea un namespace con lo stesso nome. LÃ¬ dentro *deve* esserci un secret chiamato `[nome-cluster]-import`. Se quel secret non c'Ã¨, l'Import Controller si Ã¨ bloccato. Controllate i log del controller per capire perchÃ©."

```
oc get secret -n managed-cluster
```

**Sul Managed Cluster (Il "Braccio"):**

* **Il Klusterlet:** "Sul cluster remoto viene installato un agente chiamato **Klusterlet**. Se l'importazione Ã¨ ferma, controllate lo stato di questa risorsa. Cercate condizioni come `RegistrationDesiredDegraded` o `WorkDesiredDegraded`. Devono essere `False`. Se sono `True`, il Klusterlet sta dicendo: 'Sto male, non riesco ad applicare le configurazioni'."

```
oc get klusterlets klusterlet  -o jsonpath-as-json='{.status.conditions}'
```  
---

## 3. Cluster "Pending"

"A volte vi capiterÃ  di dover importare un cluster che era giÃ  stato gestito da un altro Hub RHACM.
Qui il problema Ã¨ che il cluster ha risorse ancora intestate al vecchio cluster,, namespace sporchi.
Il nuovo Hub prova a importarlo, vede i vecchi segni e si blocca in stato **Pending**.



**Soluzione:** Pulizia profonda. Dovete cancellare il Klusterlet, i namespace `open-cluster-management-agent` e le CRD. C'Ã¨ uno script apposito nella Knowledgebase di Red Hat per fare questo 'reset di fabbrica'."

---

## 4. Il Battito Cardiaco: Status Unknown o Flapping

"Infine, il cluster Ã¨ importato, ma nella console vedete lo stato **Unknown** o, peggio, lampeggia tra **Ready** e **Unknown**."

* **Il Battito (Lease):** "RHACM funziona col concetto di 'Lease' (affitto/battito cardiaco). L'agente remoto rinnova questo lease periodicamente. Se smette, l'Hub dopo un po' lo marca come `Unknown`."
* **Diagnosi:** "Fate un `oc get managedcluster [nome]` e guardate le `.status.conditions`. Se vedete `ManagedClusterConditionAvailable` su `Unknown`, il battito si Ã¨ fermato."


```
oc get managedcluster mycluster \
  -o jsonpath-as-json='{.status.conditions}'
```


* **Il Network Instabile (Flapping):** "Se la vostra rete Ã¨ ballerina, il cluster potrebbe non riuscire a rinnovare il lease in tempo. Di default, RHACM aspetta 5 minuti (5 tentativi x 60 secondi).
Potete rendere il sistema piÃ¹ tollerante modificando il parametro `leaseDurationSeconds` nella risorsa ManagedCluster. Se lo alzate a 60 secondi, l'Hub aspetterÃ  5 minuti totali (60s x 5 tentativi) prima di dichiarare il cluster morto. Ãˆ utile per reti con alta latenza."

---

## Riepilogo Visuale (Per chiudere la lezione)

"Quindi, riassumendo la nostra strategia di detective:

1. **Network/Time/DNS:** Le basi sono solide?
2. **Hub Controller:** L'operaio sull'Hub sta lavorando (Log)?
3. **Secret:** La chiave Ã¨ stata generata?
4. **Klusterlet:** L'agente remoto sta bene?
5. **Pulizia:** Il cluster Ã¨ 'usato'? Pulitelo.

E se tutto questo fallisce? Allora Ã¨ il momento di lanciare `oc adm must-gather`, creare un archivio e chiamare il supporto Red Hat."

---

### Nota per l'istruttore:

Durante questa spiegazione, tieni aperta una finestra terminale. Anche se non esegui i comandi per risolvere un problema reale, mostra **dove** guardare (es. `oc get pods -n multicluster-engine`, o `oc get managedcluster`). Questo collega la teoria alla memoria visiva.





> **In RHACM NON stai â€œdebuggando un clusterâ€, ma una relazione distribuita Hub â†” Managed Cluster.**

Ogni problema multicluster ricade SEMPRE in una di queste 4 categorie:

1. **ConnettivitÃ **
2. **Trust (certificati / CA / tempo)**
3. **Agenti ACM (klusterlet & controller)**
4. **Stato dichiarativo incoerente (CR â‰  realtÃ )**

Se gli studenti imparano a classificare il problema prima di scavare, hanno giÃ  vinto metÃ  debugging.

---

# 1ï¸âƒ£ Troubleshooting fase â€œcluster creation / importâ€ (Day-0)

## ğŸ”¹ Checklist rapida (da proiettare in slide)

Quando un cluster **non compare / non si registra**:

| Categoria | Verifica                 |
| --------- | ------------------------ |
| Network   | 6443 + 443 bidirezionali |
| DNS       | API hub â†” API managed    |
| TLS       | CA trust reciproco       |
| Time      | chrony / NTP             |
| Images    | pull secret / registry   |

ğŸ‘‰ **90% dei problemi di import sono qui**.

---

## ğŸ”¸ Network (classico problema multicluster)

Punto chiave:

* **non basta che il managed cluster raggiunga lâ€™hub**
* **anche lâ€™hub deve raggiungere il managed**

ğŸ’¡ In ambienti enterprise:

* firewall stateful
* proxy
* NAT asimmetrici

Frase utile in aula:

> â€œSe Ã¨ un problema di rete, ACM non Ã¨ rotto: sta facendo il suo lavoro.â€

---

## ğŸ”¸ TLS e CA (problema tipico ambienti disconnessi)

Scenario classico:

* CA interna
* certificati custom
* trust non allineato

Cosa ricordare:

* **hub e managed devono fidarsi a vicenda**
* CA deve stare:

  * nel trust bundle
  * nei componenti che parlano API

ğŸ‘‰ Collegamento diretto a ZTP:

* se sbagli qui, **ZTP fallisce silenziosamente**

---

## ğŸ”¸ Time drift (sottovalutato ma micidiale)

Se vedi:

* join intermittente
* lease che scade

ğŸ‘‰ **pensa subito a NTP**

RHACM usa:

* lease
* certificati
* token temporizzati

ğŸ“Œ Regola dâ€™oro:

> *â€œSe il tempo non Ã¨ sincronizzato, il cluster Ã¨ â€˜schizofrenicoâ€™.â€*

---

## ğŸ”¸ Pull secret / immagini

Tipico ambiente Telecom:

* **disconnesso**
* registry interno
* mirroring

Se il managed cluster:

* non pulla immagini ACM
* gli agenti non partono

ğŸ‘‰ il cluster **non si registrerÃ  mai**

---

# 2ï¸âƒ£ Import controller (Hub side)

Quando la creazione/import **si blocca lato hub**, devi guardare:

### ğŸ”¹ managedcluster-import-controller-v2

Namespace:

```
multicluster-engine
```

Label:

```
app=managedcluster-import-controller-v2
```

Comandi da sapere **a memoria**:

```bash
oc get pods -n multicluster-engine \
  -l app=managedcluster-import-controller-v2

oc logs -n multicluster-engine \
  -l app=managedcluster-import-controller-v2
```

ğŸ¯ Insight didattico:

> Se il controller non crea la secret di import, **il problema NON Ã¨ nel managed cluster**.

---

## ğŸ”¸ Import Secret mancante

Per ogni cluster:

```
namespace = <cluster-name>
secret = <cluster-name>-import
```

Se manca:

* controller crashato
* permessi
* errore di comunicazione

ğŸ‘‰ **GitOps non câ€™entra nulla qui**
ğŸ‘‰ sei ancora in **Day-0**

---

# 3ï¸âƒ£ Klusterlet: IL CR PIÃ™ IMPORTANTE DA SAPER LEGGERE

Se câ€™Ã¨ **una sola risorsa** da insegnare a leggere bene, Ã¨ questa.

## ğŸ”¹ Klusterlet (sul managed cluster)

Condizioni chiave:

* `RegistrationDesiredDegraded`
* `WorkDesiredDegraded`

Devono essere:

```
status: False
```

Se sono `True`:

* agenti non partiti
* immagini non pullate
* errori di config

ğŸ’¡ Frase â€œda corsoâ€:

> â€œSe il klusterlet Ã¨ degradato, tutto il resto Ã¨ rumore.â€

---

# 4ï¸âƒ£ Pending Import (cluster giÃ  usato)

Problema **100% multicluster**, impossibile in single cluster.

Scenario:

* cluster giÃ  attaccato a un altro hub
* detach incompleto
* risorse ACM rimaste

Sintomo:

* import **Pending** per sempre

Soluzione:

* cleanup totale:

  * klusterlet
  * namespace agent
  * CRD ACM

ğŸ¯ Punto importante:

> **Un cluster puÃ² avere UN solo hub.**
> ACM non perdona i detach sporchi.

---

# 5ï¸âƒ£ ManagedCluster in stato Error / Unknown

## ğŸ”¹ ManagedCluster (hub side)

Ãˆ la **fonte di veritÃ ** per lo stato globale.

Condizione piÃ¹ importante:

```
ManagedClusterConditionAvailable
```

Se:

* `Unknown`
* `False`

ğŸ‘‰ **non andare subito sui workload**
ğŸ‘‰ torna al klusterlet

---

## ğŸ”¸ Caso tipico: Lease Update Stopped

Messaggio:

```
Registration agent stopped updating its lease
```

Cause tipiche:

* rete instabile
* firewall
* proxy
* MTU

Qui ACM sta dicendo:

> â€œIo non sento piÃ¹ il cluster, non so se Ã¨ vivo o morto.â€

---

# 6ï¸âƒ£ Stato che flappa: Ready â†” Unknown

Problema **tipico edge / WAN**.

Default:

* leaseDurationSeconds = 60
* retry = 5
* grace period = 5 minuti

Puoi:

* **aumentare leaseDurationSeconds**

Esempio:

```yaml
spec:
  leaseDurationSeconds: 120
```

ğŸ‘‰ Grace period = 10 minuti

ğŸ’¡ Insight importante:

> Questo NON risolve il problema di rete,
> ma evita falsi positivi operativi.

---

# 7ï¸âƒ£ Collegamento diretto con ZTP & GitOps

Qui devi essere molto chiaro in aula:

### ZTP

* dipende da:

  * import stabile
  * klusterlet sano
  * lease affidabile

Se vedi:

* policy non applicate
* CGU bloccate
* site config ignorate

ğŸ‘‰ **il problema Ã¨ quasi sempre prima**

---

### GitOps

* GitOps **non crea la connessione**
* GitOps **assume che il cluster sia Ready**

ğŸ“Œ Frase chiave:

> â€œGitOps non ripara cluster rotti. GitOps orchestra cluster sani.â€

---

# 8ï¸âƒ£ Sequenza corretta di troubleshooting (da insegnare)

**Ordine corretto (sempre):**

1. Network / DNS / TLS
2. Import controller (hub)
3. Import secret
4. Klusterlet (managed)
5. ManagedCluster status
6. Placement / policy / GitOps

âŒ Saltare passi = perdere ore

---

# 9ï¸âƒ£ Mini-checklist â€œda Telecomâ€

Se ti fanno domande avanzate, puoi rispondere cosÃ¬:

* â€œIn ambienti disconnessi, il **pull delle immagini** Ã¨ il primo sospettatoâ€
* â€œSe il cluster flappa, **non Ã¨ ACM**, Ã¨ la WANâ€
* â€œSe ZTP non applica policy, **il cluster non Ã¨ davvero Ready**â€
* â€œIl klusterlet Ã¨ il mio primo comando di debugâ€

---
 
